<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Safety meter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background:#1a188a;
      color:white;
      margin:0;
      padding:20px;
    }
    h1 { margin:10px; }

    /* ส่วน Min Max Avg */
    .stats {
      display: flex;
      justify-content: space-around;
      font-size: 20px;
      margin-top: 10px;
    }
    .stats div { text-align: center; }
    .stats span {
      display: block;
      font-size: 22px;
      font-weight: bold;
      margin-top: 5px;
    }

    /* meter bar */
    .meter-bar {
      width:90%;
      height:40px;
      margin:20px auto;
      border:3px solid #ccc;
      border-radius:5px;
      background: linear-gradient(to right, limegreen, yellow, orange, orangered, red);
      position:relative;
    }

    /* pointer ฟ้า */
    .pointer {
      width:0; height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-top:20px solid cyan;
      position:absolute;
      top:40px;
      left:0;
      transform:translateX(-50%);
    }

    /* bar ดำวิ่งตาม pointer */
    .moving-bar {
      position:absolute;
      top:0; bottom:0;
      width:4px;
      background:black;
      left:0;
      transform:translateX(-50%);
    }

    /* circle */
    .circle {
      width:250px;
      height:250px;
      margin:40px auto;
      border-radius:50%;
      border:10px solid cyan;
      display:flex;
      align-items:center;
      justify-content:center;
      background:black;
      flex-direction:column;
    }
    #dbValue { font-size:32px; font-weight:bold; }
    .warning {
      font-size:18px;
      margin-top:10px;
      color:orange;
    }

    /* ปุ่ม */
    .btn {
      display:block;
      width:80%;
      margin:15px auto;
      padding:15px;
      font-size:18px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-weight: bold;
    }
    .blue { background:#3ba9ff; color:white; }
    .red { background:#ff4444; color:white; }
    .green { background:#00a878; color:white; }
  </style>
</head>
<body>
  <!-- Min Max Avg -->
  <div class="stats">
    <div>Min <span id="minDb">--</span> dB</div>
    <div>Max <span id="maxDb">--</span> dB</div>
    <div>Avg <span id="avgDb">--</span> dB</div>
  </div>

  <h1>Safety meter</h1>

  <div class="meter-bar" id="meter">
    <div id="movingBar" class="moving-bar"></div>
    <div id="pointer" class="pointer"></div>
  </div>

  <!-- วงกลม -->
  <div class="circle">
    <div id="dbValue">-- dB</div>
    <div id="warning" class="warning"></div>
  </div>

  <!-- ปุ่ม -->
  <button class="btn blue">1. Input/edit personal information</button>
  <button class="btn red">2. Show record analysis</button>
  <button class="btn green">3. Recovery mode</button>

  <script>
    let audioContext, analyser, mic, javascriptNode;
    // ค่า min/max/avg
    let minDb = Infinity;
    let maxDb = -Infinity;
    let sumDb = 0;
    let countDb = 0;
    let lastSaveTime = Date.now();

    // เวลาเช็คสั่นครั้งล่าสุด
    let lastVibrateTime = 0;

    function resetStats(){
      minDb = Infinity;
      maxDb = -Infinity;
      sumDb = 0;
      countDb = 0;
    }

    function updateDisplay(){
      document.getElementById("minDb").innerText = (minDb === Infinity ? "--" : minDb.toFixed(1));
      document.getElementById("maxDb").innerText = (maxDb === -Infinity ? "--" : maxDb.toFixed(1));
      document.getElementById("avgDb").innerText = (countDb === 0 ? "--" : (sumDb/countDb).toFixed(1));
    }

    function saveStats(db){
      if(db < minDb) minDb = db;
      if(db > maxDb) maxDb = db;

      if(Date.now() - lastSaveTime > 1000){
        sumDb += db;
        countDb++;
        lastSaveTime = Date.now();
      }
      updateDisplay();
    }

    function startMeter(){
      navigator.mediaDevices.getUserMedia({audio:true})
      .then(stream=>{
        audioContext = new (window.AudioContext||window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        mic = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048,1,1);

        mic.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);

        javascriptNode.onaudioprocess = function(){
          let buffer = new Float32Array(analyser.fftSize);
          analyser.getFloatTimeDomainData(buffer);

          let sum=0;
          for(let i=0;i<buffer.length;i++){
            sum+=buffer[i]*buffer[i];
          }
          let rms=Math.sqrt(sum/buffer.length);
          let db=20*Math.log10(rms)+100;

          if(isNaN(db)) return;

          document.getElementById("dbValue").innerText = db.toFixed(1)+" dB";

          let pos = Math.min(120, Math.max(0, db));
          let leftPercent = (pos/120)*100;
          document.getElementById("pointer").style.left = leftPercent+"%";
          document.getElementById("movingBar").style.left = leftPercent+"%";

          saveStats(db);

          if(db > 85){
            document.getElementById("warning").innerText="⚠️ ระวังเสียงดังเกินไป!";
          } else {
            document.getElementById("warning").innerText="";
          }

          // 🚨 ถ้าเสียงเกิน 90 dB ให้สั่น (ทุกๆ 5 วินาที)
          if(db > 90){
            let now = Date.now();
            if(now - lastVibrateTime > 5000){ // 5 วิ
              if(navigator.vibrate){
                navigator.vibrate([200, 100, 200]); 
              }
              lastVibrateTime = now;
            }
          }
        };
      })
      .catch(err=>alert("Mic error: "+err));
    }

    // reset ทุก 1 ชม.
    setInterval(resetStats, 3600000);

    window.onload = ()=> startMeter();
  </script>
</body>
</html>
