<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Sound Meter (Index)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #1a188a;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h1 { margin: 10px; }
    .stats {
      display: flex;
      justify-content: space-around;
      font-size: 18px;
      margin-top: 10px;
    }
    .stats div { text-align: center; }
    .stats span {
      display: block;
      font-size: 20px;
      font-weight: bold;
      margin-top: 5px;
    }
    .meter-bar {
      width: 90%;
      height: 40px;
      margin: 20px auto;
      border: 3px solid #ccc;
      border-radius: 5px;
      background: linear-gradient(to right, limegreen, yellow, orange, orangered, red);
      position: relative;
    }
    .pointer {
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 20px solid cyan;
      position: absolute;
      top: 40px;
      left: 0;
      transform: translateX(-50%);
    }
    .moving-bar {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background: black;
      left: 0;
      transform: translateX(-50%);
    }
    .circle {
      width: 200px;
      height: 200px;
      margin: 20px auto;
      border-radius: 50%;
      border: 8px solid cyan;
      display: flex;
      align-items: center;
      justify-content: center;
      background: black;
      flex-direction: column;
    }
    #dbValue { font-size: 28px; font-weight: bold; }
    .warning { font-size: 16px; margin-top: 10px; color: orange; }
    .btn {
      display: block;
      width: 80%;
      margin: 10px auto;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .blue { background: #3ba9ff; color: white; }
    .red { background: #ff4444; color: white; }
    .green { background: #00a878; color: white; }

    /* ‚úÖ Popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
    .popup {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      animation: fadein 0.5s ease;
    }
    @keyframes fadein {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Index)</h1>

  <div class="stats">
    <div>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î <span id="minDb">--</span> dB</div>
    <div>‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î <span id="maxDb">--</span> dB</div>
    <div>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <span id="avgDb">--</span> dB</div>
  </div>

  <div class="meter-bar">
    <div id="movingBar" class="moving-bar"></div>
    <div id="pointer" class="pointer"></div>
  </div>

  <div class="circle">
    <div id="dbValue">-- dB</div>
    <div id="warning" class="warning"></div>
  </div>

  <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÜ -->
  <button class="btn blue" onclick="window.open('personal.html', '_blank')">
    1. ‡πÉ‡∏™‡πà/‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
  </button>

  <button class="btn red" onclick="window.open('report.html', '_blank')">
    2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  </button>

  <button class="btn green" onclick="window.open('recovery.html', '_blank')">
    3. ‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô
  </button>

  <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <div id="popup" class="popup">‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 85 dB!</div>

  <script>
    let audioContext, analyser, mic, javascriptNode;
    let minDb = Infinity, maxDb = -Infinity, sumDb = 0, countDb = 0;
    let lastSaveTime = Date.now();
    let alertActive = false;

    // ‚úÖ ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏ö
    const channel = new BroadcastChannel("dbChannel");

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup + beep + ‡∏™‡∏±‡πà‡∏ô
    function showPopupAlert() {
      if (alertActive) return;
      alertActive = true;

      const popup = document.getElementById("popup");
      popup.style.display = "block";

      // üîä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á beep
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.type = "sine";
        oscillator.frequency.value = 1000; // Hz
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1);
        setTimeout(() => oscillator.stop(), 1000);
      } catch (e) {
        console.warn("Beep failed:", e);
      }

      // üì≥ ‡∏™‡∏±‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (navigator.vibrate) navigator.vibrate([300, 100, 300]);

      // ‚è±Ô∏è Popup ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô 30 ‡∏ß‡∏¥
      setTimeout(() => {
        popup.style.display = "none";
        alertActive = false;
      }, 30000);
    }

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    function updateDisplay(db){
      const minVal = (minDb === Infinity ? "--" : minDb.toFixed(1));
      const maxVal = (maxDb === -Infinity ? "--" : maxDb.toFixed(1));
      const avgVal = (countDb === 0 ? "--" : (sumDb/countDb).toFixed(1));

      document.getElementById("minDb").innerText = minVal;
      document.getElementById("maxDb").innerText = maxVal;
      document.getElementById("avgDb").innerText = avgVal;
      document.getElementById("dbValue").innerText = db.toFixed(1)+" dB";

      // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ report.html
      channel.postMessage({ min:minVal, max:maxVal, avg:avgVal, db:db.toFixed(1), time:Date.now() });
    }

    function saveStats(db){
      if(db < minDb) minDb = db;
      if(db > maxDb) maxDb = db;
      if(Date.now() - lastSaveTime > 1000){
        sumDb += db;
        countDb++;
        lastSaveTime = Date.now();
      }
      updateDisplay(db);
    }

    function startMeter(){
      navigator.mediaDevices.getUserMedia({audio:true})
      .then(stream=>{
        audioContext = new (window.AudioContext||window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        mic = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048,1,1);

        mic.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);

        javascriptNode.onaudioprocess = function(){
          const buffer = new Float32Array(analyser.fftSize);
          analyser.getFloatTimeDomainData(buffer);

          let sum = 0;
          for(let i=0;i<buffer.length;i++) sum += buffer[i]*buffer[i];
          const rms = Math.sqrt(sum / buffer.length);
          let db = 20 * Math.log10(rms) + 100;
	  if (!isFinite(db)) db = 0;


          if(isNaN(db)) return;

          const pos = Math.min(120, Math.max(0, db));
          const leftPercent = (pos / 120) * 100;
          document.getElementById("pointer").style.left = leftPercent + "%";
          document.getElementById("movingBar").style.left = leftPercent + "%";

          if(db > 85){
            document.getElementById("warning").innerText="‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!";
            showPopupAlert();
          } else {
            document.getElementById("warning").innerText="";
          }

          saveStats(db);
        };
      })
      .catch(err=>alert("Mic error: " + err));
    }

    window.onload = ()=> startMeter();
  </script>
</body>
</html>
