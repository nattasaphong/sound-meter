<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Report)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #ff4d4d;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h1 {
      background: #ffcc00;
      color: black;
      border-radius: 10px;
      padding: 10px 20px;
      display: inline-block;
      font-size: 22px;
      margin-bottom: 20px;
    }
    h1 span {
      background: #444;
      color: white;
      padding: 6px 14px;
      border-radius: 50%;
      margin-right: 10px;
      font-weight: bold;
    }
    h2 {
      background: #c0392b;
      color: white;
      padding: 8px;
      border-radius: 8px;
      font-size: 18px;
      margin-top: 10px;
      display: inline-block;
    }
    .control-panel {
      margin: 15px auto;
      background: #333;
      border-radius: 10px;
      padding: 10px 20px;
      width: fit-content;
    }
    select {
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    canvas {
      display: block;
      background: #fff;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 800px;
      width: 90%;
      height: 350px;
    }
    .stat-box {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
    }
    .stat-item {
      background: #e74c3c;
      padding: 12px 25px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
      min-width: 90px;
      text-align: center;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    .daily-box {
      background: #444;
      border-radius: 10px;
      padding: 15px;
      width: 85%;
      max-width: 550px;
      margin: 20px auto;
      text-align: left;
      font-size: 16px;
      line-height: 1.8;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.4);
    }
    button {
      background: #ffcc00;
      color: black;
      font-weight: bold;
      border: none;
      padding: 10px 25px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
      margin: 10px;
    }
    button:hover {
      background: #ffe066;
    }
    .frame-box {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #222;
      padding: 15px;
      width: 85%;
      max-width: 550px;
      border-radius: 8px;
      margin: 25px auto;
      text-align: left;
    }
    .frame-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      border-radius: 5px;
    }
    .safe { color: #00FF80; }
    .warn { color: #FFD700; }
    .danger { color: #FF4040; }
  </style>
</head>
<body>
  <h1><span>2</span>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h1>

  <h2>‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ Zoom)</h2>
  <div class="control-panel">
    <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏£‡∏≤‡∏ü: </label>
    <select id="timeRange">
      <option value="1000" selected>1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="30000">30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="60000">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="1800000">30 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
      <option value="3600000">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
    </select>
  </div>

  <canvas id="dbChart" height="400"></canvas>

  <div class="stat-box">
    <div class="stat-item">MIN<br><span id="minVal">--</span> dB</div>
    <div class="stat-item">MAX<br><span id="maxVal">--</span> dB</div>
    <div class="stat-item">AVG<br><span id="avgVal">--</span> dB</div>
  </div>

  <h2>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏µ‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</h2>
  <div class="daily-box" id="dailyData">
    <div>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ : <span id="avgToday">--</span> dB</div>
    <div>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠ : <span id="maxToday">--</span> dB</div>
    <div>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á : <span id="duration">--</span> ‡∏ô‡∏≤‡∏ó‡∏µ</div>
    <div>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á : <span id="levelText">--</span></div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô : <span id="recovery">--</span> ‡∏ô‡∏≤‡∏ó‡∏µ</span>
      <button id="weeklyPdfBtn" style="background:#ff5722;color:white;padding:8px 18px;border-radius:6px;">üìÑ PDF ‡∏£‡∏≤‡∏¢‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</button>
    </div>
  </div>

  <h2>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (frame)</h2>
  <p>time frame ‡∏•‡∏∞ 4 ‡∏ä‡∏°. ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 4 ‡∏ä‡∏°. ‡∏°‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
  <div class="frame-box" id="frameContainer"></div>

  <script>
    // ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢ (THSarabunNew) ‡∏ù‡∏±‡∏á‡πÅ‡∏ö‡∏ö Base64
    const { jsPDF } = window.jspdf;
    const thaiFontUrl = "https://raw.githubusercontent.com/napatwongchr/jsPDF-Thai-Font/main/THSarabunNew-normal.js";
    const script = document.createElement("script");
    script.src = thaiFontUrl;
    document.head.appendChild(script);

    let chart;
    let channel = new BroadcastChannel("dbChannel");
    let allData = [];
    let firstTime = null;

    channel.onmessage = (e) => {
      const data = e.data;
      const db = parseFloat(data.db);
      allData.push({ time: data.time, db });

      document.getElementById("minVal").innerText = data.min;
      document.getElementById("maxVal").innerText = data.max;
      document.getElementById("avgVal").innerText = data.avg;
      document.getElementById("avgToday").innerText = data.avg;
      document.getElementById("maxToday").innerText = data.max;

      if (!firstTime) firstTime = data.time;
      const durationMin = ((data.time - firstTime) / 60000).toFixed(1);
      document.getElementById("duration").innerText = durationMin;

      const level = db < 60 ? "‡πÄ‡∏á‡∏µ‡∏¢‡∏ö" : db < 85 ? "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" : "‡∏î‡∏±‡∏á‡∏°‡∏≤‡∏Å";
      document.getElementById("levelText").innerText = level;
      const recovery = db < 60 ? 5 : db < 85 ? 15 : 30;
      document.getElementById("recovery").innerText = recovery;

      updateChart();
      updateFrames();
    };

    function updateChart() {
      const range = parseInt(document.getElementById("timeRange").value);
      const now = Date.now();
      const filtered = allData.filter(d => now - d.time <= range);
      const labels = filtered.map(d => new Date(d.time).toLocaleTimeString());
      const values = filtered.map(d => d.db);

      if (!chart) {
        chart = new Chart(document.getElementById("dbChart"), {
          type: "line",
          data: { labels, datasets: [{ label: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (dB)", data: values, borderColor: "red", backgroundColor: "rgba(255,0,0,0.2)", fill: true }] },
          options: { animation: false, scales: { y: { beginAtZero: true, max: 120 } } }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update();
      }
    }

    function updateFrames() {
      const container = document.getElementById("frameContainer");
      container.innerHTML = "";
      if (allData.length === 0) return;

      const startOfDay = new Date();
      startOfDay.setHours(0, 0, 0, 0);
      const startTime = startOfDay.getTime();
      const frameDuration = 4 * 60 * 60 * 1000;

      for (let i = 0; i < 6; i++) {
        const frameStart = startTime + i * frameDuration;
        const frameEnd = frameStart + frameDuration;
        const frameData = allData.filter(d => d.time >= frameStart && d.time < frameEnd);
        let avg = "--";
        if (frameData.length > 0) {
          const sum = frameData.reduce((a, b) => a + b.db, 0);
          avg = (sum / frameData.length).toFixed(1);
        }
        const status = avg === "--" ? { text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", color: "warn" } :
                       avg < 70 ? { text: "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤", color: "safe" } :
                       avg < 85 ? { text: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", color: "warn" } :
                                  { text: "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å", color: "danger" };
        const div = document.createElement("div");
        div.className = "frame-item";
        div.innerHTML = `
          <span class="${status.color}">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà ${i + 1} (${i * 4}:00 - ${(i + 1) * 4}:00)</span>
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avg} dB</span>
          <span class="${status.color}">${status.text}</span>
        `;
        container.appendChild(div);
      }

      const btn = document.createElement("button");
      btn.textContent = "‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Frame (PDF)";
      btn.style.background = "#ff9800";
      btn.style.color = "white";
      btn.style.alignSelf = "flex-end";
      container.appendChild(btn);

      btn.addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("THSarabunNew", "normal");
        doc.setFontSize(18);
        doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Frame ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô", 105, 20, { align: "center" });
        doc.setFontSize(12);
        let y = 40;
        document.querySelectorAll(".frame-item").forEach((el, i) => {
          doc.text(`${i + 1}. ${el.innerText}`, 10, y);
          y += 10;
          if (y > 270) { doc.addPage(); y = 20; }
        });
        doc.save("frame_report.pdf");
      });
    }

    document.getElementById("weeklyPdfBtn").addEventListener("click", () => {
      const doc = new jsPDF();
      doc.setFont("THSarabunNew", "normal");
      const avg = document.getElementById("avgToday").innerText;
      const max = document.getElementById("maxToday").innerText;
      const dur = document.getElementById("duration").innerText;
      const lev = document.getElementById("levelText").innerText;
      const rec = document.getElementById("recovery").innerText;
      doc.setFontSize(20);
      doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", 105, 20, { align: "center" });
      let y = 40;
      [ 
        `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ : ${avg} dB`, 
        `‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î : ${max} dB`,
        `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á : ${dur} ‡∏ô‡∏≤‡∏ó‡∏µ`,
        `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á : ${lev}`,
        `‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô : ${rec} ‡∏ô‡∏≤‡∏ó‡∏µ`
      ].forEach(line => { doc.text(line, 20, y); y += 10; });
      const canvas = document.getElementById("dbChart");
      const img = canvas.toDataURL("image/png");
      doc.addImage(img, "PNG", 20, y + 10, 170, 90);
      doc.save("sound_report_weekly.pdf");
    });
  </script>
</body>
</html>
